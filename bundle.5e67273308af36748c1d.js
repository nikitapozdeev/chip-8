(()=>{"use strict";const s=Object.freeze([240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128]),t=document.getElementById("chip8"),e=t.getContext("2d"),i="#CADC9F";t.width=640,t.height=320,e.fillStyle=i,e.fillRect(0,0,t.width,t.height),e.scale(10,10);function r(s,t){const e=new KeyboardEvent(s,{keyCode:t});window.dispatchEvent(e)}const h=JSON.parse('["BMP Viewer - Hello (C8 example) [Hap, 2005]","Breakout (Brix hack) [David Winter, 1997]","Brick (Brix hack, 1990)","Brix [Andreas Gustafsson, 1990]","Chip8 emulator Logo [Garstyciuks]","Clock Program [Bill Fisher, 1981]","Delay Timer Test [Matthew Mikolay, 2010]","Division Test [Sergey Naydenov, 2010]","IBM Logo","Landing","Life [GV Samways, 1980]","Lunar Lander (Udo Pernisz, 1979)","Maze (alt) [David Winter, 199x]","Maze [David Winter, 199x]","Particle Demo [zeroZshadow, 2008]","Random Number Test [Matthew Mikolay, 2010]","Stars [Sergey Naydenov, 2010]","anEveningToDieFor","chip8-picture","chip8-test-rom-with-audio","chip8-test-rom","octojam1title","octojam2title","octopeg","pong","superneatboy","test_opcode"]');!function(){const t=h.map((s=>`<div class='rom' data-key='${s}'>${s}</div>`)).join(""),r=document.getElementById("roms");r.insertAdjacentHTML("beforeend",t),r.addEventListener("click",(t=>{t.target.classList.contains("rom")&&function(t){const r=new class{constructor(){this.ram=new Uint8Array(4096),this.video=this.createVideo(),this.registers=new Uint8Array(16),this.I=0,this.stack=new Uint16Array(16),this.ip=512,this.sp=-1,this.dt=0,this.st=0,this.speed=10,this.running=!1,this.loadFont(),this.speaker=new class{constructor(){this._context=new(window.AudioContext||window.webkitAudioContext),this._oscillator=this._context.createOscillator(),this._oscillator.connect(this._context.destination),this._isStarted=!1}play(){this._isStarted?this._context.resume():(this._oscillator.frequency.setTargetAtTime(440,this._context.currentTime,0),this._oscillator.start(0),this._isStarted=!0)}stop(){this._context.suspend()}},this.keyboard=new class{constructor(){this.keyMap={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,68:15},this.pressedKeys={},this.waitForKeyPressCallback=null,this.subscribeToEvents()}subscribeToEvents(){window.addEventListener("keydown",this.onKeyDownEvent.bind(this)),window.addEventListener("keyup",this.onKeyUpEvent.bind(this))}onKeyDownEvent({keyCode:s}){const t=this.keyMap[s];t&&(this.pressedKeys[t]=!0,this.waitForKeyPressCallback&&(this.waitForKeyPressCallback(t),this.waitForKeyPressCallback=null))}onKeyUpEvent({keyCode:s}){const t=this.keyMap[s];t&&this.pressedKeys[t]&&delete this.pressedKeys[t]}isKeyPressed(s){return!!this.pressedKeys[s]}waitForKeyPress(s){this.waitForKeyPressCallback=s}}}createVideo(){const s=[];for(let t=0;t<32;t++){const t=[];for(let s=0;s<64;s++)t[s]=0;s.push(t)}return s}loadFont(){for(let t=0;t<s.length;t++)this.ram[t]=s[t]}draw(){for(let s=0;s<32;s++)for(let t=0;t<64;t++)1===this.video[s][t]?e.fillStyle="#306230":e.fillStyle=i,e.fillRect(t,s,1,1)}start(){this.running=!0,console.log("power on");const s=1e3/60;let t;const e=i=>{t&&(i-t).toFixed(2)>=s.toFixed(2)&&this.tick(),t=i,window.requestAnimationFrame(e)};window.requestAnimationFrame(e)}tick(){for(let s=0;s<this.speed;++s)this.running&&this.processInstruction();this.running&&(this.updateTimers(),this.processAudio(),this.draw())}updateTimers(){this.dt>0&&this.dt--,this.st>0&&this.st--}processAudio(){this.st>0?this.speaker.play():this.speaker.stop()}processInstruction(){const s=this.getOpCode(),t=4095&s,e=15&s,i=s>>8&15,r=s>>4&15,h=255&s;if(224===s)this.cls();else if(238===s)this.ret();else if(4096==(61440&s))this.jp(t);else if(8192==(61440&s))this.call(t);else if(12288==(61440&s))this.seVx(i,h);else if(16384==(61440&s))this.sneVx(i,h);else if(20480==(61440&s))this.seVxVy(i,r);else if(24576==(61440&s))this.ldVx(i,h);else if(28672==(61440&s))this.addVx(i,h);else if(32768==(61455&s))this.ldVxVy(i,r);else if(32769==(61455&s))this.orVxVy(i,r);else if(32770==(61455&s))this.andVxVy(i,r);else if(32771==(61455&s))this.xorVxVy(i,r);else if(32772==(61455&s))this.addVxVy(i,r);else if(32773==(61455&s))this.subVxVy(i,r);else if(32774==(61455&s))this.shrVx(i);else if(32775==(61455&s))this.subnVxVy(i,r);else if(32782==(61455&s))this.shlVx(i);else if(36864==(61455&s))this.sneVxVy(i,r);else if(40960==(61440&s))this.ld(t);else if(45056==(61440&s))this.jpV0(t);else if(49152==(61440&s))this.rndVx(i,h);else if(53248==(61440&s))this.drwVxVy(i,r,e);else if(57502==(61695&s))this.skpVx(i);else if(57505==(61695&s))this.sknpVx(i);else if(61447==(61695&s))this.ldVxDt(i);else if(61450==(61695&s))this.ldVxK(i);else if(61461==(61695&s))this.ldDtVx(i);else if(61464==(61695&s))this.ldStVx(i);else if(61470==(61695&s))this.addIVx(i);else if(61481==(61695&s))this.ldFVx(i);else if(61491==(61695&s))this.ldBVx(i);else if(61525==(61695&s))this.ldIVx(i);else{if(61541!=(61695&s))throw new Error("unknown command "+s.toString(16).padStart(4,"0"));this.ldVxI(i)}}sys(s){this.ip=s}cls(){this.video=this.createVideo()}ret(){if(-1===this.sp)throw new Error("Stack underflow");this.ip=this.stack[this.sp],this.sp--}jp(s){this.ip=s}call(s){if(this.sp++,this.sp>this.stack.length)throw new Error("Stack overflow");this.stack[this.sp]=this.ip,this.ip=s}seVx(s,t){this.registers[s]===t&&(this.ip+=2)}sneVx(s,t){this.registers[s]!==t&&(this.ip+=2)}seVxVy(s,t){this.registers[s]===this.registers[t]&&(this.ip+=2)}ldVx(s,t){this.registers[s]=t}addVx(s,t){this.registers[s]+=t}ldVxVy(s,t){this.registers[s]=this.registers[t]}orVxVy(s,t){this.registers[s]|=this.registers[t]}andVxVy(s,t){this.registers[s]&=this.registers[t]}xorVxVy(s,t){this.registers[s]^=this.registers[t]}addVxVy(s,t){this.registers[s]+=this.registers[t],this.registers[s]>255?(this.registers[s]&=255,this.registers[15]=1):this.registers[15]=0}subVxVy(s,t){this.registers[s]>this.registers[t]?this.registers[15]=1:this.registers[15]=0,this.registers[s]-=this.registers[t]}shrVx(s){255==(255&this.registers[s])?this.registers[15]=1:this.registers[15]=0,this.registers[s]=this.registers[s]>>1}subnVxVy(s,t){this.registers[t]>this.registers[s]?this.registers[15]=1:this.registers[15]=0,this.registers[t]-=this.registers[s]}shlVx(s){65280==(65280&this.registers[s])?this.registers[15]=1:this.registers[15]=0,this.registers[s]=this.registers[s]<<1}sneVxVy(s,t){this.registers[s]!==this.registers[t]&&(this.ip+=2)}ld(s){this.I=s}jpV0(s){this.pc=s+this.registers[0]}rndVx(s,t){const e=Math.ceil(256*Math.random());this.registers[s]=e&t}drwVxVy(s,t,e){s=this.registers[s],t=this.registers[t];let i=!1;const r=this.ram.slice(this.I,this.I+e);for(let e=0;e<r.length;e++){const h=r[e].toString(2).padStart(8,"0").split("").map(Number);for(let r=0;r<h.length;r++){const o=t+e,n=s+r,a=this.video[o%32][n%64]^h[r];1===this.video[o%32][n%64]&&0===a&&(i=!0),this.video[o%32][n%64]=a,this.registers[15]=i?1:0}}}skpVx(s){const t=this.registers[s];this.keyboard.isKeyPressed(t)&&(this.ip+=2)}sknpVx(s){const t=this.registers[s];this.keyboard.isKeyPressed(t)||(this.ip+=2)}ldVxDt(s){this.registers[s]=this.dt}ldVxK(s){this.running=!1,this.keyboard.waitForKeyPress((t=>{this.registers[s]=t,this.running=!0}))}ldDtVx(s){this.dt=this.registers[s]}ldStVx(s){this.st=this.registers[s]}addIVx(s){this.I+=this.registers[s]}ldFVx(s){this.I=5*this.registers[s]}ldBVx(s){let t=this.registers[s];const e=Math.floor(t/100);t-=100*e;const i=Math.floor(t/10);t-=10*i;const r=Math.floor(t);this.ram[this.I]=e,this.ram[this.I+1]=i,this.ram[this.I+2]=r}ldIVx(s){for(let t=0;t<=s;t++)this.ram[this.I+t]=this.registers[t]}ldVxI(s){for(let t=0;t<=s;t++)this.registers[t]=this.ram[this.I+t]}getOpCode(){return this.ram[this.ip++]<<8|this.ram[this.ip++]}load(s){for(let t=0;t<s.byteLength;t++)this.ram[this.ip+t]=s[t]}};fetch(`./roms/${t}.ch8`).then((s=>s.arrayBuffer())).then((s=>new Uint8Array(s))).then((s=>{r.load(s),r.start()}))}(t.target.getAttribute("data-key"))}))}(),function(){const s=document.getElementById("keyboard"),t="keyboard__key",e="data-key";s.addEventListener("mousedown",(s=>{s.target.classList.contains(t)&&r("keydown",s.target.getAttribute(e).charCodeAt(0))})),s.addEventListener("mouseup",(s=>{s.target.classList.contains(t)&&r("keyup",s.target.getAttribute(e).charCodeAt(0))}))}()})();