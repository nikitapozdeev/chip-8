(()=>{"use strict";const t=Object.freeze([240,144,144,144,240,32,96,32,32,112,240,16,240,128,240,240,16,240,16,240,144,144,240,16,16,240,128,240,16,240,240,128,240,144,240,240,16,32,64,64,240,144,240,144,240,240,144,240,16,240,240,144,240,144,144,224,144,224,144,224,240,128,128,128,240,224,144,144,144,224,240,128,240,128,240,240,128,240,128,128]),s=document.getElementById("chip8"),i=s.getContext("2d"),e="#CADC9F";s.width=640,s.height=320,i.fillStyle=e,i.fillRect(0,0,s.width,s.height),i.scale(10,10);function h(t,s){const i=new KeyboardEvent(t,{keyCode:s});window.dispatchEvent(i)}const o=JSON.parse('["BMP Viewer - Hello (C8 example) [Hap, 2005]","Breakout (Brix hack) [David Winter, 1997]","Brick (Brix hack, 1990)","Brix [Andreas Gustafsson, 1990]","Chip8 emulator Logo [Garstyciuks]","Clock Program [Bill Fisher, 1981]","Delay Timer Test [Matthew Mikolay, 2010]","Division Test [Sergey Naydenov, 2010]","IBM Logo","Landing","Life [GV Samways, 1980]","Lunar Lander (Udo Pernisz, 1979)","Maze (alt) [David Winter, 199x]","Maze [David Winter, 199x]","Particle Demo [zeroZshadow, 2008]","Random Number Test [Matthew Mikolay, 2010]","Stars [Sergey Naydenov, 2010]","anEveningToDieFor","chip8-picture","chip8-test-rom-with-audio","chip8-test-rom","octojam1title","octojam2title","octopeg","pong","superneatboy","test_opcode"]');!function(){const s=o.map((t=>`<div class='rom' data-key='${t}'>${t}</div>`)).join(""),h=document.getElementById("roms");h.insertAdjacentHTML("beforeend",s),h.addEventListener("click",(s=>{s.target.classList.contains("rom")&&function(s){const h=new class{constructor(){this.ram=new Uint8Array(4096),this.video=this.createVideo(),this.V=new Uint8Array(16),this.I=0,this.stack=new Uint16Array(16),this.PC=512,this.SP=-1,this.DT=0,this.ST=0,this.speed=10,this.running=!1,this.loadFont(),this.speaker=new class{constructor(){this._context=new(window.AudioContext||window.webkitAudioContext),this._oscillator=this._context.createOscillator(),this._oscillator.connect(this._context.destination),this._isStarted=!1}play(){this._isStarted?this._context.resume():(this._oscillator.frequency.setTargetAtTime(440,this._context.currentTime,0),this._oscillator.start(0),this._isStarted=!0)}stop(){this._context.suspend()}},this.keyboard=new class{constructor(){this.keyMap={49:1,50:2,51:3,52:12,81:4,87:5,69:6,82:13,65:7,83:8,68:9,70:14,90:10,88:0,67:11,68:15},this.pressedKeys={},this.waitForKeyPressCallback=null,this.subscribeToEvents()}subscribeToEvents(){window.addEventListener("keydown",this.onKeyDownEvent.bind(this)),window.addEventListener("keyup",this.onKeyUpEvent.bind(this))}onKeyDownEvent({keyCode:t}){const s=this.keyMap[t];s&&(this.pressedKeys[s]=!0,this.waitForKeyPressCallback&&(this.waitForKeyPressCallback(s),this.waitForKeyPressCallback=null))}onKeyUpEvent({keyCode:t}){const s=this.keyMap[t];s&&this.pressedKeys[s]&&delete this.pressedKeys[s]}isKeyPressed(t){return!!this.pressedKeys[t]}waitForKeyPress(t){this.waitForKeyPressCallback=t}}}createVideo(){const t=[];for(let s=0;s<32;s++){const s=[];for(let t=0;t<64;t++)s[t]=0;t.push(s)}return t}loadFont(){for(let s=0;s<t.length;s++)this.ram[s]=t[s]}draw(){for(let t=0;t<32;t++)for(let s=0;s<64;s++)1===this.video[t][s]?i.fillStyle="#306230":i.fillStyle=e,i.fillRect(s,t,1,1)}start(){this.running=!0,console.log("power on");const t=1e3/60;let s;const i=e=>{s&&(e-s).toFixed(2)>=t.toFixed(2)&&this.tick(),s=e,window.requestAnimationFrame(i)};window.requestAnimationFrame(i)}tick(){for(let t=0;t<this.speed;++t)this.running&&this.processInstruction();this.running&&(this.updateTimers(),this.processAudio(),this.draw())}updateTimers(){this.DT>0&&this.DT--,this.ST>0&&this.ST--}processAudio(){this.ST>0?this.speaker.play():this.speaker.stop()}processInstruction(){const t=this.getOpCode(),s=4095&t,i=15&t,e=t>>8&15,h=t>>4&15,o=255&t;if(224===t)this.cls();else if(238===t)this.ret();else if(4096==(61440&t))this.jp(s);else if(8192==(61440&t))this.call(s);else if(12288==(61440&t))this.seVx(e,o);else if(16384==(61440&t))this.sneVx(e,o);else if(20480==(61440&t))this.seVxVy(e,h);else if(24576==(61440&t))this.ldVx(e,o);else if(28672==(61440&t))this.addVx(e,o);else if(32768==(61455&t))this.ldVxVy(e,h);else if(32769==(61455&t))this.orVxVy(e,h);else if(32770==(61455&t))this.andVxVy(e,h);else if(32771==(61455&t))this.xorVxVy(e,h);else if(32772==(61455&t))this.addVxVy(e,h);else if(32773==(61455&t))this.subVxVy(e,h);else if(32774==(61455&t))this.shrVx(e);else if(32775==(61455&t))this.subnVxVy(e,h);else if(32782==(61455&t))this.shlVx(e);else if(36864==(61455&t))this.sneVxVy(e,h);else if(40960==(61440&t))this.ld(s);else if(45056==(61440&t))this.jpV0(s);else if(49152==(61440&t))this.rndVx(e,o);else if(53248==(61440&t))this.drwVxVy(e,h,i);else if(57502==(61695&t))this.skpVx(e);else if(57505==(61695&t))this.sknpVx(e);else if(61447==(61695&t))this.ldVxDt(e);else if(61450==(61695&t))this.ldVxK(e);else if(61461==(61695&t))this.ldDtVx(e);else if(61464==(61695&t))this.ldStVx(e);else if(61470==(61695&t))this.addIVx(e);else if(61481==(61695&t))this.ldFVx(e);else if(61491==(61695&t))this.ldBVx(e);else if(61525==(61695&t))this.ldIVx(e);else{if(61541!=(61695&t))throw new Error("unknown command "+t.toString(16).padStart(4,"0"));this.ldVxI(e)}}sys(t){this.PC=t}cls(){this.video=this.createVideo()}ret(){if(-1===this.SP)throw new Error("Stack underflow");this.PC=this.stack[this.SP],this.SP--}jp(t){this.PC=t}call(t){if(this.SP++,this.SP>this.stack.length)throw new Error("Stack overflow");this.stack[this.SP]=this.PC,this.PC=t}seVx(t,s){this.V[t]===s&&(this.PC+=2)}sneVx(t,s){this.V[t]!==s&&(this.PC+=2)}seVxVy(t,s){this.V[t]===this.V[s]&&(this.PC+=2)}ldVx(t,s){this.V[t]=s}addVx(t,s){this.V[t]+=s}ldVxVy(t,s){this.V[t]=this.V[s]}orVxVy(t,s){this.V[t]|=this.V[s]}andVxVy(t,s){this.V[t]&=this.V[s]}xorVxVy(t,s){this.V[t]^=this.V[s]}addVxVy(t,s){this.V[t]+=this.V[s],this.V[t]>255?(this.V[t]&=255,this.V[15]=1):this.V[15]=0}subVxVy(t,s){this.V[t]>this.V[s]?this.V[15]=1:this.V[15]=0,this.V[t]-=this.V[s]}shrVx(t){255==(255&this.V[t])?this.V[15]=1:this.V[15]=0,this.V[t]=this.V[t]>>1}subnVxVy(t,s){this.V[s]>this.V[t]?this.V[15]=1:this.V[15]=0,this.V[s]-=this.V[t]}shlVx(t){65280==(65280&this.V[t])?this.V[15]=1:this.V[15]=0,this.V[t]=this.V[t]<<1}sneVxVy(t,s){this.V[t]!==this.V[s]&&(this.PC+=2)}ld(t){this.I=t}jpV0(t){this.pc=t+this.V[0]}rndVx(t,s){const i=Math.ceil(256*Math.random());this.V[t]=i&s}drwVxVy(t,s,i){t=this.V[t],s=this.V[s];let e=!1;const h=this.ram.slice(this.I,this.I+i);for(let i=0;i<h.length;i++){const o=h[i].toString(2).padStart(8,"0").split("").map(Number);for(let h=0;h<o.length;h++){const r=s+i,n=t+h,a=this.video[r%32][n%64]^o[h];1===this.video[r%32][n%64]&&0===a&&(e=!0),this.video[r%32][n%64]=a,this.V[15]=e?1:0}}}skpVx(t){const s=this.V[t];this.keyboard.isKeyPressed(s)&&(this.PC+=2)}sknpVx(t){const s=this.V[t];this.keyboard.isKeyPressed(s)||(this.PC+=2)}ldVxDt(t){this.V[t]=this.DT}ldVxK(t){this.running=!1,this.keyboard.waitForKeyPress((s=>{this.V[t]=s,this.running=!0}))}ldDtVx(t){this.DT=this.V[t]}ldStVx(t){this.ST=this.V[t]}addIVx(t){this.I+=this.V[t]}ldFVx(t){this.I=5*this.V[t]}ldBVx(t){let s=this.V[t];const i=Math.floor(s/100);s-=100*i;const e=Math.floor(s/10);s-=10*e;const h=Math.floor(s);this.ram[this.I]=i,this.ram[this.I+1]=e,this.ram[this.I+2]=h}ldIVx(t){for(let s=0;s<=t;s++)this.ram[this.I+s]=this.V[s]}ldVxI(t){for(let s=0;s<=t;s++)this.V[s]=this.ram[this.I+s]}getOpCode(){return this.ram[this.PC++]<<8|this.ram[this.PC++]}load(t){for(let s=0;s<t.byteLength;s++)this.ram[this.PC+s]=t[s]}};fetch(`./roms/${s}.ch8`).then((t=>t.arrayBuffer())).then((t=>new Uint8Array(t))).then((t=>{h.load(t),h.start()}))}(s.target.getAttribute("data-key"))}))}(),function(){const t=document.getElementById("keyboard"),s="keyboard__key",i="data-key";t.addEventListener("mousedown",(t=>{t.target.classList.contains(s)&&h("keydown",t.target.getAttribute(i).charCodeAt(0))})),t.addEventListener("mouseup",(t=>{t.target.classList.contains(s)&&h("keyup",t.target.getAttribute(i).charCodeAt(0))}))}()})();